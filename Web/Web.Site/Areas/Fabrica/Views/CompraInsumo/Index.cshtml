@{
    ViewData["Title"] = "Compras de Insumo";
    Layout = "_Layout";

    IEnumerable<CompraInsumoDetalle> DetallesCompra = ViewBag.DetallesCompra;
}

@model IEnumerable<CompraInsumo>

<div class="row wrapper border-bottom white-bg page-heading navegacion">
    <div class="col-lg-10">
        <h2>Compras</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="@Url.Action("Index", "Dashboard", new { area = "fabrica" })">Home</a>
            </li>
            <li class="breadcrumb-item">
                <a>Fabrica</a>
            </li>
            <li class="active breadcrumb-item">
                <strong>Compras</strong>
            </li>
        </ol>
    </div>
    <div class="col-lg-2 mt-1 mt-sm-2 d-flex justify-content-end align-items-end" style="text-align:right">
        <button type="button" class="btn btn-w-m btn-primary w-100"
                onclick="location.href='@Url.Action("ComprarInsumos", "CompraInsumo", 0)'">
            <span class="icon icon-xs"><span class="fas fa-shopping-cart mr-2"></span></span>Realizar Compra
        </button>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox ">
                <div class="ibox-title">
                    <h5>Compras de Insumos</h5>
                </div>
                <div class="ibox-content">
                    <div class="ibox-content">
                        <div class="table-responsive">
                            <table class="footable table table-stripped table-bordered toggle-arrow-tiny" data-page-size="15">
                                <thead>
                                    <tr>
                                        <th>#Compra</th>
                                        <th>Proveedor</th>
                                        <th>Fecha Recibido</th>
                                        <th>Fecha Ultimo Pago</th>
                                        <th>Monto Total</th>
                                        <th>Remito Asociado</th>
                                        <th data-sort-ignore="true" class="d-print-none">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model != null)
                                    {
                                        foreach (var compra in Model)
                                        {
                                            <tr>
                                                <td>@compra.Id</td>
                                                <td>@compra.Proveedor.Nombre</td>
                                                @if (compra.FechaRecibido != null)
                                                {
                                                    <td>@compra.FechaRecibido.Value.ToLongDateString()</td>
                                                }
                                                else
                                                {
                                                    <td>Aun no recibida</td>
                                                }
                                                @if (compra.FechaPagado != null)
                                                {
                                                    <td>@compra.FechaPagado.Value.ToLongDateString()</td>
                                                }
                                                else
                                                {
                                                    <td>Aun no pagada</td>
                                                }
                                                <td>@compra.MontoTotal</td>
                                                @if (compra.NroRemito != null)
                                                {
                                                    <td>@compra.NroRemito.Value</td>
                                                }
                                                else
                                                {
                                                    <td>No posee remito asociado</td>
                                                }
                                                <td class="d-print-none">
                                                    <button class="btn btn-outline btn-success btn-xs" type="button"
                                                            onclick="verDetalle(@compra.Id)"
                                                            data-toggle="modal"
                                                            data-target="#ModalDetalle">
                                                        Ver Detalles
                                                    </button>
                                                    @if (!compra.Recibido)
                                                    {
                                                        <button class="btn btn-outline btn-warning btn-xs" type="button"
                                                                onclick="marcarRecibido(@compra.Id)">
                                                            Marcar Recibido
                                                        </button>
                                                    }
                                                    else
                                                        @if (!compra.Pagado)
                                                    {
                                                        <button class="btn btn-outline btn-primary btn-xs" type="button"
                                                                onclick="marcarPagado(@compra.Id)">
                                                            Marcar Pagado
                                                        </button>
                                                    }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="7">
                                            <ul class="pagination float-right"></ul>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    @*MODAL*@

    <div class="modal inmodal fade" id="ModalDetalle" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header pb-1">
                    <div class="row">
                        <div class="col-sm-12 d-flex justify-content-center">
                            <h1 style="font-size:30px;">Detalle Compra</h1>
                        </div>
                    </div>
                </div>
                <div class="modal-body py-2">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th>Insumo</th>
                                    <th>Proveedor</th>
                                    <th>Cantidad</th>
                                    <th>Monto</th>
                                    <th>Comentario</th>
                                </tr>
                            </thead>
                            <tbody id="partialViewEventos">
                                <partial name="_CompraInsumoIndexDetalle.cshtml" model="null" />
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    



</div>

@section Styles {
    <environment names="Development,Staging,Production">
        <link rel="stylesheet" href="~/lib/dataTables/datatables.min.css" />
        <link rel="stylesheet" href="~/lib/footable/css/footable.core.min.css" />
        <link rel="stylesheet" href="~/lib/sweetalert/dist/sweetalert.css" />
    </environment>
}

@section Scripts {
    <environment names="Development,Staging,Production">
        <script src="~/lib/dataTables/datatables.min.js"></script>
        <script src="~/lib/dataTables/dataTables.bootstrap4.min.js"></script>
        <script src="~/lib/footable/dist/footable.all.min.js"></script>
        <script src="~/lib/sweetalert/dist/sweetalert.min.js"></script>
    </environment>

    <script type="text/javascript">
        $(document).ready(function () {
            $('.footable').footable();
        });
    </script>

    <script type="text/javascript">

        $(document).ready(function () {
            $('.dataTables-example').DataTable({
                pageLength: 25,
                dom: 'gitp'

            });

        });

        function verDetalle(id) {
            ActualizarDetalleCompra(id);
        }

        function ActualizarDetalleCompra(id) {
            $.ajax({
                type: "Get",
                url: "/fabrica/CompraInsumo/ActualizarDetalleCompra?IdCompra=" + id,
                traditional: true,
                data: {
                    Id: id
                },
                contentType: "application/json",
                success: function (response) {
                    $("#partialViewEventos").html(""); //clear the records content
                    $("#partialViewEventos").html(response);  //add the updated content.
                }
            });
        }        


        function marcarRecibido(id) {
            recibir(id);
        }

        function recibir(id) {
            var remitoExt = "";
            swal({
                title: "Recibir Compra",
                text: "Escribe numero de remito",
                type: "input",
                input: "int",
                animation: "slide-from-top",
                inputPlaceholder: "Numero de remito",
                confirmButtonColor: "#1ab394",
                confirmButtonText: "Ok",
                closeOnConfirm: true,
                preConfirm: (remitoInput) => {

                    remitoExt = remitoInput

                }
            }, function (remitoExt) {
                $.ajax({
                    type: "post",
                    url: "/fabrica/CompraInsumo/RecibirCompra",
                    traditional: true,
                    data: {
                        idCompra: id,
                        remito: remitoExt,
                        calificacionProveedor: 0
                    },
                    contentType: "application/json",
                    success: function (response) {
                        console.log(remitoExt)
                        if (remitoExt == "") {
                            swal('Formato no permitido', '', 'error')
                        }
                        else {
                            swal(
                                'Compra recibida',
                                'Remito: ' + remitoExt,
                                'success'
                            )
                        }
                        
                    }
                })
            })
        }

        function marcarPagado(Id) {

        }

    </script>
}

